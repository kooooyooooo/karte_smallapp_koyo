# アスレチックトレーナー向け カルテ管理アプリ 要件定義書

## 1. 概要

### 1.1. プロジェクト名
（仮称）トレーナーズ・ログ (Trainer's Log)

### 1.2. 背景
アスレチックトレーナーのカルテ記録業務は、現在Excelで行われており、入力の非効率性とデータの検索性・分析性の欠如が課題となっている。特に、選手個人の経過を時系列で追うことが困難である。

### 1.3. 目的
本プロジェクトは、モダンなWeb技術を用い、カルテ入力の効率化とデータの一元管理を実現するWebアプリケーションを開発することを目的とする。

### 1.4. MVP (Minimum Viable Product) のゴール
1.  **入力の効率化**: スマートフォンから、選択式入力主体で素早くカルテを記録できる。
2.  **時系列での参照**: 特定選手名で検索し、その選手の過去のカルテ履歴を時系列で即座に把握できる。

---

## 2. システム構成

本アプリケーションは、以下の技術スタックで構築・運用する。

### 2.1. アーキテクチャ
```
┌─────────────────┐
│   クライアント   │  Next.js 15 (React)
│  (Web Browser)  │  + TypeScript
│                 │  + Tailwind CSS
└────────┬────────┘
         │ HTTPS
         │
┌────────▼────────┐
│   Supabase      │  PostgreSQL Database
│   (BaaS)        │  + REST API
│                 │  + Real-time subscriptions
└─────────────────┘
         │
         │ Deploy
         ▼
┌─────────────────┐
│     Vercel      │  Hosting & CI/CD
└─────────────────┘
```

### 2.2. 技術スタック
* **フロントエンド**: Next.js 15 (App Router) + TypeScript + Tailwind CSS
* **バックエンド (BaaS)**: Supabase (PostgreSQL, REST API, Authentication)
* **ホスティング/デプロイ**: Vercel (自動デプロイ、CI/CD)
* **バージョン管理**: Git + GitHub

---

## 3. ユーザーと利用シーン

### 3.1. メインユーザー
* アスレチックトレーナー（ユーザー本人）

### 3.2. 利用シーン
* **SCENE 1: 現場での記録**
    * 練習中や練習直後、グラウンドやトレーナールームで、スマホから選手の状態をヒアリングしながら即時入力する。
* **SCENE 2: 経過の確認**
    * リハビリメニュー作成時やコーチへの報告前に、スマホで当該選手の過去の履歴を時系列で確認する。

---

## 4. 機能要件 (MVP)

### 4.1. 選手マスタ管理機能 (Players)
* 【F-001】 選手の基本情報（氏名、所属チーム、背番号など）を登録・編集・削除できる。(CRUD)
* 【F-002】 カルテ入力時に、登録された選手名をドロップダウンリストから選択できる。

#### 画面仕様
* **選手一覧画面** (`/players`)
  * 選手の一覧表示（名前、チーム、背番号）
  * 新規登録ボタン
  * 各選手の「カルテ」「編集」「削除」ボタン
* **選手登録・編集フォーム**
  * 選手名（必須）
  * 所属チーム（任意）
  * 背番号（任意）

### 4.2. カルテ入力機能 (Charts)
* 【F-003】 スマートフォン・タブレットから新規カルテを作成できる。
* 【F-004】 以下の項目を入力できるフォームを設ける。
    * **日付** (Date): 必須。デフォルトで当日。
    * **選手名** (Player): 必須。選手マスタからの**選択式**。
    * **ステータス** (Status): 必須。練習参加可否（完全合流, 一部参加, 別メニュー, 見学）を**選択式**で入力。
    * **S (主観的症状)**: テキスト入力（複数行）。選手の訴え。
    * **O (客観的評価)**: テキスト入力（複数行）。トレーナーの観察所見。
    * **A (評価)**: テキスト入力（複数行）。総合的な評価。
    * **P (計画・処置)**:
        * **処置内容 (Treatments)**: （アイシング, テーピング, マッサージ, ストレッチ指導など）を**複数選択式（チェックボックス）**で入力。
        * **リハビリ・指導内容 (Plan Text)**: テキスト入力（複数行）。

#### 画面仕様
* **カルテ入力画面** (`/charts/new`)
  * 日付入力（date picker）
  * 選手選択（dropdown）
  * ステータス選択（ボタングループ）
  * SOAP各項目のテキストエリア
  * 処置内容のチェックボックスリスト
  * 登録ボタン、キャンセルボタン

### 4.3. カルテ検索・閲覧機能 (View)
* 【F-005】 **選手別 時系列閲覧（最重要機能）**:
    * 選手一覧ページ（または検索窓）から選手を選択する。
    * 選択した選手の過去のカルテ（日付、ステータス、Sの概要など）が**時系列（新しい順）で一覧表示**される。
* 【F-006】 一覧から特定のカルテを選択すると、入力された詳細内容（F-004）を閲覧・編集できる。

#### 画面仕様
* **選手詳細画面** (`/players/[id]`)
  * 選手情報表示（名前、チーム、背番号）
  * 新規カルテ入力ボタン
  * カルテ履歴一覧（時系列、新しい順）
    * 各カルテ: 日付、ステータス、主観的症状の要約、処置内容タグ
    * 詳細・編集ボタン、削除ボタン
* **カルテ詳細画面** (`/charts/[id]`)
  * 閲覧モード: 全項目の表示
  * 編集モード: 全項目の編集フォーム
  * 編集/更新/キャンセルボタン

---

## 5. データモデル (Supabase データベース設計)

Supabase上に以下のテーブルを作成する。

### 5.1. `players` (選手マスタ)
| カラム名 | 型 | 説明 | 制約 |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | 主キー (自動生成) | PK, DEFAULT gen_random_uuid() |
| `created_at` | `timestamp with time zone` | 作成日時 | NOT NULL, DEFAULT now() |
| `user_id` | `uuid` | 作成したトレーナー | NOT NULL, FK (将来の users.id) |
| `name` | `text` | 選手名 | NOT NULL |
| `team` | `text` | 所属チーム | NULL可 |
| `number` | `text` | 背番号 | NULL可 |

**インデックス:**
- `idx_players_user_id` on `user_id`
- `idx_players_name` on `name`

### 5.2. `charts` (カルテ)
| カラム名 | 型 | 説明 | 制約 |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | 主キー (自動生成) | PK, DEFAULT gen_random_uuid() |
| `created_at` | `timestamp with time zone` | 作成日時 | NOT NULL, DEFAULT now() |
| `date` | `date` | カルテの日付 (入力日) | NOT NULL |
| `player_id` | `uuid` | 選手ID | FK (players.id), NOT NULL, ON DELETE CASCADE |
| `user_id` | `uuid` | 記録したトレーナー | NOT NULL, FK (将来の users.id) |
| `status` | `text` | ステータス | NOT NULL |
| `subjective` | `text` | S: 主観的症状 | NULL可 |
| `objective` | `text` | O: 客観的評価 | NULL可 |
| `assessment` | `text` | A: 評価 | NULL可 |
| `plan_text` | `text` | P: リハビリ・指導内容 | NULL可 |
| `treatments` | `text[]` | P: 処置内容 (配列) | NULL可 |

**インデックス:**
- `idx_charts_player_id` on `player_id`
- `idx_charts_user_id` on `user_id`
- `idx_charts_date` on `date DESC`

**外部キー制約:**
- `player_id` → `players(id)` ON DELETE CASCADE

---

## 6. 画面設計

### 6.1. 画面一覧
| 画面名 | パス | 説明 |
|--------|------|------|
| トップページ | `/` | 各機能へのナビゲーション |
| 選手一覧・管理 | `/players` | 選手のCRUD操作 |
| 選手詳細・カルテ履歴 | `/players/[id]` | 選手別カルテ時系列表示 |
| カルテ新規入力 | `/charts/new` | SOAP形式でのカルテ入力 |
| カルテ詳細・編集 | `/charts/[id]` | カルテの閲覧・編集 |

### 6.2. 画面遷移図
```
トップページ (/)
  ├─→ 選手管理 → 選手一覧 (/players)
  │              ├─→ 選手詳細 (/players/[id])
  │              │    └─→ 新規カルテ入力 (/charts/new?playerId=xxx)
  │              │         └─→ カルテ詳細 (/charts/[id])
  │              └─→ 新規選手登録 (同ページ内モーダル)
  │
  ├─→ カルテ入力 → 新規カルテ入力 (/charts/new)
  │
  └─→ カルテ検索 → 選手一覧 (/players)
                   └─→ 選手詳細 (/players/[id])
```

### 6.3. UIデザイン方針
* **モバイルファースト**: スマートフォンでの操作を最優先
* **大きなタップターゲット**: ボタンやリンクは指で押しやすいサイズ（最小44x44px）
* **明確な色分け**: ステータスごとに色を変える（完全合流=緑、見学=赤など）
* **シンプルなナビゲーション**: 階層を深くせず、2-3タップで目的の画面に到達
* **高速表示**: データ取得は3秒以内、ローディング表示で待機感を軽減

---

## 7. 非機能要件

### 7.1. インフラストラクチャ
* **データベース**: Supabase (PostgreSQL) を使用する。
* **デプロイ**: Vercel にデプロイし、自動デプロイ（CI/CD）を設定する。
* **ドメイン**: 初期は Vercel のサブドメイン（xxx.vercel.app）を使用。

### 7.2. パフォーマンス
* **ページ読み込み**: 初回ロード3秒以内、以降のページ遷移1秒以内
* **データ取得**: 選手の検索、カルテの時系列表示は3秒以内に完了
* **レスポンス**: ユーザー操作（ボタンクリック等）に対して100ms以内に反応

### 7.3. 対応デバイス
* **スマートフォン**: iOS Safari, Android Chrome の最新版
* **タブレット**: iPad Safari, Android タブレット Chrome
* **PC**: Chrome, Safari, Edge, Firefox の最新版（参照用）

### 7.4. セキュリティ
* **データ分離**: Supabase の RLS (Row Level Security) を設定（将来実装）
  * MVP版ではRLSは無効化（単一ユーザー想定）
  * Phase 2でユーザー認証機能と共に実装予定
* **通信の暗号化**: HTTPS通信を使用
* **環境変数管理**: API KeyなどはVercelの環境変数で管理

### 7.5. 可用性
* **稼働率**: Vercel/Supabaseの標準SLAに準拠（99.9%想定）
* **バックアップ**: Supabaseの自動バックアップ機能を利用

### 7.6. 保守性
* **コード品質**: TypeScriptによる型安全性、ESLintによる静的解析
* **ドキュメント**: README、デプロイガイド、本要件定義書を整備
* **バージョン管理**: GitHubでソースコード管理、PRベースの開発フロー

---

## 8. 外部インターフェース

### 8.1. Supabase REST API
* **認証**: Supabase Anon Key（公開API Key）を使用
* **エンドポイント**: 
  - `GET /rest/v1/players` - 選手一覧取得
  - `POST /rest/v1/players` - 選手登録
  - `PATCH /rest/v1/players?id=eq.{id}` - 選手更新
  - `DELETE /rest/v1/players?id=eq.{id}` - 選手削除
  - `GET /rest/v1/charts` - カルテ一覧取得
  - `POST /rest/v1/charts` - カルテ登録
  - `PATCH /rest/v1/charts?id=eq.{id}` - カルテ更新
  - `DELETE /rest/v1/charts?id=eq.{id}` - カルテ削除

### 8.2. 環境変数
```bash
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

---

## 9. 開発・テスト

### 9.1. 開発環境
* **Node.js**: v18以上
* **npm**: v9以上
* **エディタ**: VS Code推奨

### 9.2. テスト方針
* **ビルドテスト**: `npm run build` でエラーなくビルドできること
* **型チェック**: TypeScriptの型エラーがないこと
* **リントチェック**: ESLintのエラーがないこと
* **ブラウザテスト**: 
  - 各画面がスマホで正常に表示されること
  - CRUD操作が正常に動作すること
  - 時系列表示が正しい順序で表示されること

### 9.3. デプロイフロー
```
開発 (feature branch)
  ↓ commit & push
GitHub Repository
  ↓ Pull Request
レビュー & マージ (main branch)
  ↓ 自動トリガー
Vercel 自動デプロイ
  ↓
本番環境 (xxx.vercel.app)
```

---

## 10. MVPスコープ外 (将来構想 / Phase 2)

以下の機能はMVPでは実装せず、将来の拡張として検討する。

### 10.1. 認証・権限管理
* ユーザー登録・ログイン機能
* 複数トレーナーのアカウント管理
* RLS (Row Level Security) の有効化

### 10.2. 高度な入力支援
* 人体イラストをタップして部位を選択する機能
* 音声入力、手書きメモのAI-OCR
* 疾患名に基づくカルテテンプレートの自動生成

### 10.3. データ分析・可視化
* チーム全体の怪我の傾向分析（例：「肉離れが多い」）やグラフ化
* アラート機能（例：「疲労度が高い選手」の自動検出）
* ダッシュボード画面

### 10.4. 連携・共有
* 監督、コーチ、選手への自動共有（インジュリーシートのPDF出力）
* リハビリ動画や写真ファイルの添付
* カレンダー連携

### 10.5. その他
* オフライン対応（PWA化）
* 複数言語対応（多言語化）
* データエクスポート（CSV, Excel）

---

## 11. 用語集

| 用語 | 説明 |
|------|------|
| SOAP | 医療記録の標準的な形式。S(主観的症状), O(客観的評価), A(評価), P(計画) |
| NRS | Numerical Rating Scale。痛みの度合いを0-10の数値で評価 |
| RLS | Row Level Security。Supabaseのデータベース行レベルのアクセス制御機能 |
| BaaS | Backend as a Service。バックエンド機能をクラウドサービスとして提供 |
| CRUD | Create, Read, Update, Delete。データベースの基本操作 |
| MVP | Minimum Viable Product。必要最小限の機能で構成された製品 |

---

## 12. 承認・改訂履歴

| 版数 | 日付 | 改訂内容 | 承認者 |
|------|------|----------|--------|
| 1.0 | 2024-11-13 | 初版作成 | - |

---

## 13. 添付資料

* [要求定義書](./要求定義書.md)
* [デプロイガイド](../DEPLOYMENT.md)
* [README](../README.md)
* [データベーススキーマ](../supabase/schema.sql)
