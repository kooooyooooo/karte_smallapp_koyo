# トレーナーズ・ログ 機能仕様書

## 目次
1. [機能一覧](#1-機能一覧)
2. [画面別詳細仕様](#2-画面別詳細仕様)
3. [データ操作仕様](#3-データ操作仕様)
4. [バリデーション仕様](#4-バリデーション仕様)
5. [エラーハンドリング](#5-エラーハンドリング)

---

## 1. 機能一覧

| 機能ID | 機能名 | 優先度 | 実装状況 |
|--------|--------|--------|----------|
| F-001 | 選手マスタ管理（CRUD） | 高 | ✅ 完了 |
| F-002 | カルテ入力（SOAP形式） | 高 | ✅ 完了 |
| F-003 | 選手別カルテ時系列閲覧 | 高 | ✅ 完了 |
| F-004 | カルテ詳細閲覧・編集 | 高 | ✅ 完了 |
| F-005 | レスポンシブデザイン | 高 | ✅ 完了 |

---

## 2. 画面別詳細仕様

### 2.1. トップページ (`/`)

#### 概要
アプリケーションのエントリーポイント。主要な3つの機能へのナビゲーションを提供。

#### UI要素
- **ヘッダー**
  - アプリ名: 「トレーナーズ・ログ」
  - サブタイトル: 「アスレチックトレーナー向けカルテ管理」
  
- **メインコンテンツ** (3つのカードボタン)
  1. **選手管理** (青色)
     - 説明: 「選手の登録・編集・削除」
     - リンク先: `/players`
  2. **カルテ入力** (緑色)
     - 説明: 「新規カルテの記録」
     - リンク先: `/charts/new`
  3. **カルテ検索** (紫色)
     - 説明: 「選手別時系列閲覧」
     - リンク先: `/players`

- **フッター**
  - コピーライト表示

#### 動作仕様
- 各カードをタップすると、対応する画面に遷移
- ホバー時に背景色が薄く変化（PCのみ）

---

### 2.2. 選手一覧・管理画面 (`/players`)

#### 概要
登録されている選手の一覧表示と、新規登録・編集・削除操作を行う画面。

#### UI要素

**ヘッダー**
- タイトル: 「選手管理」
- ホームリンク: 「← ホーム」

**新規登録ボタン**
- テキスト: 「＋ 新規選手登録」
- クリックでフォーム表示/非表示を切り替え

**登録・編集フォーム** (表示/非表示切替可能)
- **選手名** (必須)
  - type: text
  - placeholder: なし
  - validation: 空でないこと
- **所属チーム** (任意)
  - type: text
  - placeholder: なし
- **背番号** (任意)
  - type: text
  - placeholder: なし
- **ボタン**
  - 登録/更新ボタン (青色)
  - キャンセルボタン (グレー)

**選手一覧**
- 選手がいない場合: 「選手が登録されていません」メッセージ
- 各選手カード:
  - 選手名 (太字・大きめ)
  - 所属チーム (表示があれば)
  - 背番号 (表示があれば)
  - **ボタン群**:
    - カルテ (紫色): 選手詳細画面へ遷移
    - 編集 (黄色): フォームに値を読み込み
    - 削除 (赤色): 確認後に削除

#### 動作仕様

**新規登録**
1. 「＋ 新規選手登録」ボタンをクリック
2. フォームが表示される
3. 必須項目を入力し「登録」ボタンをクリック
4. Supabaseに登録リクエスト送信
5. 成功時: アラート表示 → フォームクリア → 一覧再読み込み
6. 失敗時: エラーアラート表示

**編集**
1. 選手カードの「編集」ボタンをクリック
2. フォームに選手情報が読み込まれる
3. 情報を修正し「更新」ボタンをクリック
4. Supabaseに更新リクエスト送信
5. 成功時: アラート表示 → フォームクリア → 一覧再読み込み
6. 失敗時: エラーアラート表示

**削除**
1. 選手カードの「削除」ボタンをクリック
2. 確認ダイアログ表示: 「この選手を削除してもよろしいですか？」
3. OKの場合: Supabaseに削除リクエスト送信
4. 成功時: アラート表示 → 一覧再読み込み
5. 失敗時: エラーアラート表示

**データ取得**
- ページロード時に全選手を取得
- ソート順: 名前の昇順

---

### 2.3. 選手詳細・カルテ履歴画面 (`/players/[id]`)

#### 概要
特定の選手のカルテ履歴を時系列（新しい順）で表示する、MVP最重要画面。

#### UI要素

**ヘッダー**
- 選手名 (大きく表示)
- 所属チーム、背番号
- 戻るリンク: 「← 選手一覧」

**新規カルテ入力ボタン**
- テキスト: 「＋ 新規カルテ入力」
- リンク先: `/charts/new?playerId={選手ID}`

**カルテ履歴一覧**
- カルテがない場合: 「カルテがまだ登録されていません」メッセージ
- 各カルテカード:
  - **日付** (大きく表示): 例「2024年11月13日」
  - **ステータスバッジ**:
    - 完全合流: 緑色
    - 一部参加: 黄色
    - 別メニュー: オレンジ色
    - 見学: 赤色
  - **S（主観的症状）**: 100文字まで表示（長い場合は「...」で省略）
  - **処置内容**: タグ形式で表示（青色）
  - **ボタン群**:
    - 詳細・編集 (青色): カルテ詳細画面へ
    - 削除 (赤色): 確認後に削除

#### 動作仕様

**データ取得**
1. ページロード時に選手情報とカルテ一覧を取得
2. カルテは日付の降順でソート（新しい順）
3. 選手が存在しない場合: 「選手が見つかりません」メッセージ

**カルテ削除**
1. 「削除」ボタンをクリック
2. 確認ダイアログ: 「このカルテを削除してもよろしいですか？」
3. OKの場合: Supabaseに削除リクエスト送信
4. 成功時: アラート表示 → 一覧再読み込み

**ステータスの色分け**
- 完全合流: bg-green-100 text-green-800 border-green-300
- 一部参加: bg-yellow-100 text-yellow-800 border-yellow-300
- 別メニュー: bg-orange-100 text-orange-800 border-orange-300
- 見学: bg-red-100 text-red-800 border-red-300

---

### 2.4. カルテ新規入力画面 (`/charts/new`)

#### 概要
SOAP形式で新規カルテを入力する画面。スマホでの快適な入力を最優先。

#### UI要素

**ヘッダー**
- タイトル: 「新規カルテ入力」
- サブタイトル: 「SOAP形式でカルテを記録」
- ホームリンク: 「← ホーム」

**入力フォーム** (各セクションは白背景のカードで区切り)

1. **日付** (必須)
   - type: date
   - デフォルト値: 当日
   
2. **選手名** (必須)
   - type: select
   - オプション: 登録されている全選手
   - 表示形式: 「選手名 (背番号) - チーム」
   - デフォルト: 「選手を選択してください」
   - クエリパラメータ`playerId`があれば自動選択

3. **ステータス** (必須)
   - type: ボタングループ（4つのボタン）
   - 選択肢: 完全合流 / 一部参加 / 別メニュー / 見学
   - デフォルト: 完全合流
   - 選択時: 青色強調、非選択時: グレー

4. **S（主観的症状）**
   - type: textarea (4行)
   - placeholder: 例文あり
   - 説明: 「選手の訴え、痛みの部位、発症時期など」

5. **O（客観的評価）**
   - type: textarea (4行)
   - placeholder: 例文あり
   - 説明: 「発生機序、痛みの度合い、可動域、所見など」

6. **A（評価）**
   - type: textarea (4行)
   - placeholder: 例文あり
   - 説明: 「トレーナーによる評価・判断」

7. **P（処置内容）**
   - type: checkbox (複数選択可能)
   - 選択肢: 
     - アイシング
     - テーピング
     - マッサージ
     - ストレッチ指導
     - 筋力トレーニング指導
     - 可動域訓練
     - 電気療法
     - 超音波療法
   - レイアウト: 2列グリッド

8. **P（リハビリ・指導内容）**
   - type: textarea (4行)
   - placeholder: 例文あり
   - 説明: 「リハビリメニューや今後の計画など」

**ボタン**
- 登録ボタン (緑色・大きめ): 「カルテを登録」
- キャンセルボタン (グレー): 前の画面に戻る

#### 動作仕様

**初期表示**
1. クエリパラメータ`playerId`があれば、該当選手を自動選択
2. 日付は当日を自動設定
3. ステータスは「完全合流」を自動選択

**登録処理**
1. 「カルテを登録」ボタンをクリック
2. バリデーションチェック:
   - 日付が入力されているか
   - 選手が選択されているか
   - ステータスが選択されているか
3. Supabaseにカルテ登録リクエスト送信
4. 成功時: アラート表示 → 選手詳細画面へ遷移
5. 失敗時: エラーアラート表示

**キャンセル**
- 前の画面（選手詳細 or ホーム）に戻る

---

### 2.5. カルテ詳細・編集画面 (`/charts/[id]`)

#### 概要
カルテの詳細を閲覧し、必要に応じて編集できる画面。

#### UI要素

**ヘッダー**
- タイトル: 「カルテ詳細」
- 選手名
- 戻るリンク: 「← 選手詳細」

**モード切替**
- 初期表示: 閲覧モード
- 「編集する」ボタン: 編集モードに切替

**閲覧モード**
- 各項目を白背景のカードで表示
  - 日付
  - ステータス（バッジ表示）
  - S（主観的症状）
  - O（客観的評価）
  - A（評価）
  - P（処置内容）: タグ表示
  - P（リハビリ・指導内容）
- 「編集する」ボタン (黄色)

**編集モード**
- 各項目を入力フォームで表示（新規入力画面と同様）
- 「更新」ボタン (青色)
- 「キャンセル」ボタン (グレー): 閲覧モードに戻る

#### 動作仕様

**データ取得**
1. ページロード時にカルテ情報と選手情報を取得
2. カルテが存在しない場合: 「カルテが見つかりません」メッセージ

**編集モードへ切替**
1. 「編集する」ボタンをクリック
2. 編集モードに切り替わる
3. 現在のデータが入力フォームに読み込まれる

**更新処理**
1. 「更新」ボタンをクリック
2. バリデーションチェック（新規入力と同様）
3. Supabaseにカルテ更新リクエスト送信
4. 成功時: アラート表示 → 閲覧モードに戻る → データ再読み込み
5. 失敗時: エラーアラート表示

**キャンセル**
- 閲覧モードに戻る（変更は破棄）

---

## 3. データ操作仕様

### 3.1. Supabaseクライアント設定

**ファイル**: `lib/supabase.ts`

```typescript
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co';
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-key';

export const supabase = createClient(supabaseUrl, supabaseAnonKey);
```

### 3.2. 選手マスタ操作

**一覧取得**
```typescript
const { data, error } = await supabase
  .from("players")
  .select("*")
  .order("name");
```

**新規登録**
```typescript
const { error } = await supabase.from("players").insert([
  {
    name: "選手名",
    team: "チーム名",
    number: "背番号",
    user_id: "00000000-0000-0000-0000-000000000000", // 仮のユーザーID
  },
]);
```

**更新**
```typescript
const { error } = await supabase
  .from("players")
  .update({
    name: "選手名",
    team: "チーム名",
    number: "背番号",
  })
  .eq("id", 選手ID);
```

**削除**
```typescript
const { error } = await supabase
  .from("players")
  .delete()
  .eq("id", 選手ID);
```

### 3.3. カルテ操作

**選手別カルテ一覧取得**
```typescript
const { data, error } = await supabase
  .from("charts")
  .select("*")
  .eq("player_id", 選手ID)
  .order("date", { ascending: false });
```

**新規登録**
```typescript
const { error } = await supabase.from("charts").insert([
  {
    date: "2024-11-13",
    player_id: "選手ID",
    status: "完全合流",
    subjective: "主観的症状",
    objective: "客観的評価",
    assessment: "評価",
    plan_text: "リハビリ・指導内容",
    treatments: ["アイシング", "テーピング"],
    user_id: "00000000-0000-0000-0000-000000000000",
  },
]);
```

**詳細取得**
```typescript
const { data, error } = await supabase
  .from("charts")
  .select("*")
  .eq("id", カルテID)
  .single();
```

**更新**
```typescript
const { error } = await supabase
  .from("charts")
  .update({
    date: "2024-11-13",
    status: "完全合流",
    subjective: "主観的症状",
    objective: "客観的評価",
    assessment: "評価",
    plan_text: "リハビリ・指導内容",
    treatments: ["アイシング", "テーピング"],
  })
  .eq("id", カルテID);
```

**削除**
```typescript
const { error } = await supabase
  .from("charts")
  .delete()
  .eq("id", カルテID);
```

---

## 4. バリデーション仕様

### 4.1. 選手登録・編集

| 項目 | ルール | エラーメッセージ |
|------|--------|------------------|
| 選手名 | 必須、空でない | ブラウザデフォルト |
| 所属チーム | 任意 | - |
| 背番号 | 任意 | - |

### 4.2. カルテ入力・編集

| 項目 | ルール | エラーメッセージ |
|------|--------|------------------|
| 日付 | 必須 | ブラウザデフォルト |
| 選手名 | 必須、選択されていること | 「選手を選択してください」 |
| ステータス | 必須、4択のいずれか | - |
| S | 任意 | - |
| O | 任意 | - |
| A | 任意 | - |
| 処置内容 | 任意（複数選択可） | - |
| リハビリ・指導内容 | 任意 | - |

---

## 5. エラーハンドリング

### 5.1. データ取得エラー

**発生タイミング**: Supabaseからのデータ取得失敗時

**対応**:
1. コンソールにエラーログ出力
2. アラート表示: 「データの取得に失敗しました」
3. 空のデータ状態で表示

### 5.2. データ登録・更新・削除エラー

**発生タイミング**: Supabaseへのデータ操作失敗時

**対応**:
1. コンソールにエラーログ出力
2. アラート表示:
   - 登録: 「選手/カルテの保存に失敗しました」
   - 更新: 「選手/カルテの更新に失敗しました」
   - 削除: 「選手/カルテの削除に失敗しました」
3. 画面状態は変更しない（ユーザーが再試行可能）

### 5.3. ネットワークエラー

**発生タイミング**: Supabaseとの通信失敗時

**対応**:
1. コンソールにエラーログ出力
2. アラート表示: 「通信エラーが発生しました」
3. ユーザーに再試行を促す

### 5.4. 存在しないデータへのアクセス

**発生タイミング**: 
- 削除済み/存在しない選手IDでアクセス
- 削除済み/存在しないカルテIDでアクセス

**対応**:
1. 「選手が見つかりません」or「カルテが見つかりません」メッセージ表示
2. 前の画面に戻るリンク提供

---

## 6. レスポンシブデザイン仕様

### 6.1. ブレークポイント

Tailwind CSSのデフォルトブレークポイントを使用:
- `sm`: 640px
- `md`: 768px
- `lg`: 1024px
- `xl`: 1280px

### 6.2. モバイル (< 768px)

- シングルカラムレイアウト
- フルスクリーン幅の使用
- タップターゲットサイズ: 最小44x44px
- フォントサイズ: 本文16px以上
- ボタン高さ: 最小48px

### 6.3. タブレット (768px - 1023px)

- 基本はモバイルと同様
- カードレイアウトでは余白を増やす
- 一部要素（選手一覧など）で2カラム表示

### 6.4. PC (>= 1024px)

- 最大幅制限: 1024px (max-w-4xl)
- 中央寄せ表示
- ホバーエフェクト追加
- カードレイアウトで2-3カラム表示

---

## 7. パフォーマンス要件

### 7.1. ページロード時間

| 画面 | 目標時間 |
|------|----------|
| トップページ | < 1秒 |
| 選手一覧 | < 3秒 |
| 選手詳細 | < 3秒 |
| カルテ入力 | < 2秒 |
| カルテ詳細 | < 3秒 |

### 7.2. データ取得

- 選手一覧: 100件以下 → 即座に表示
- カルテ一覧: 選手1人あたり100件以下 → 3秒以内

### 7.3. 最適化手法

- Next.js 15のApp Routerによる自動最適化
- `dynamic = 'force-dynamic'`による動的レンダリング
- Supabaseのインデックス活用
- Tailwind CSSによるCSSの最小化

---

## 8. アクセシビリティ

### 8.1. 基本方針

- セマンティックHTMLの使用
- 適切なコントラスト比の確保
- キーボード操作対応
- スクリーンリーダー対応（aria-label等）

### 8.2. 実装状況

MVP版では基本的なアクセシビリティを確保:
- `<button>`タグの使用
- フォーム要素の`<label>`対応
- 適切な見出し階層 (`h1`, `h2`, `h3`)

Phase 2で高度なアクセシビリティ対応を検討。

---

## 9. 今後の拡張予定

Phase 2以降で実装予定の機能については、[要件定義書](./要件定義書.md)の「10. MVPスコープ外」を参照。
